# Detection Rule: Identifying Discrepancies Between Cloud Activity and Device Logs

## KQL Query

```kql
let activeUsersO = OfficeActivity
| where TimeGenerated > ago(15m) 
| where IsManagedDevice == true
| distinct user = tolower(UserId);
let activeDevices = DeviceNetworkEvents
| where TimeGenerated > ago(1h)
| distinct user = tolower(InitiatingProcessAccountUpn);
activeUsersO
| join kind=leftanti activeDevices on user
| where isnotempty(user);
```
# Logic Behind the Rule
This detection rule cross-references activities from **OfficeActivity** logs (generated in the cloud) with **DeviceNetworkEvents** logs sent from endpoints (Microsoft Defender for Endpoint).

## Key Points:

 **OfficeActivity Logs:**
  These logs are generated in the cloud when users perform actions in Microsoft tools like SharePoint, OneDrive, Teams, or Exchange.
  Data is collected by Azure Sentinel.
  Reference: Microsoft Documentation - https://learn.microsoft.com/en-us/azure/azure-monitor/reference/tables/officeactivity.
  
**DeviceNetworkEvents Logs:**
  These logs are generated by Defender on the endpoint and sent to MDE.
  If a device is compromised and Defender is silenced (e.g., through tampering or traffic filtering), these logs may stop, even if the device remains online.
  
**Why Cross-Referencing Helps:**
  By comparing these two data sources, you can identify discrepancies that may indicate potential security issues, such as tampered Defender agents or misconfigured devices.


## Scenarios Detected:
This rule flags users who have performed actions in the cloud from managed devices, but corresponding Defender logs are missing. Possible reasons include:

**Defender Tampering:**
  Defender has been silenced or tampered with, preventing log generation (e.g., using tools like EDRSilencer or filtering traffic).
  
**Managed but Non-Onboarded Devices:**
  Devices such as corporate-issued iPhones may be managed but not onboarded with Defender.
  
**Misconfigurations in Defender:**
  Legitimate issues, such as sensors not sending logs, may cause discrepancies.
  
**Blind Spots:**
  Environments like Citrix VDI, which are managed but lack Defender, may create logging gaps.

## Known Limitations
**Lack of Cloud Activities:**
  If users do not perform actions that generate OfficeActivity logs (e.g., using SharePoint, OneDrive, Teams, Exchange), the query will not trigger, even if Defender is down.
  
**False Positives:**
  Managed but non-onboarded devices (e.g., corporate-issued iPhones) may cause false positives.
  
  Mitigation: Create a watchlist of all managed but non-onboarded devices and exclude their activities from the query.
  
**Ingestion Delays:**
  Differences in ingestion times between OfficeActivity and DeviceNetworkEvents may temporarily cause discrepancies.

## Investigation Steps
When the rule triggers, follow these steps to investigate:

**Check for Previous DeviceNetworkEvents:**
  Determine if there are prior logs for the flagged device. If so, ingestion delays might be the issue.
  
**Identify the Device Type:**
  Use the UserAgent field in OfficeActivity logs and cross-reference with device information in Entra ID.
  
  Verify whether the flagged device is a corporate-issued iPhone or another non-onboarded device.
  
**Analyze Common Factors:**
  If multiple results are flagged, look for patterns or commonalities among the devices or users.
  
**Check for VDI Usage:**
  Investigate whether the organization uses VDIs (e.g., Citrix) that might not be covered by Defender.
  
  
## Rule Customization and Fine-Tuning
  This is a general-purpose rule. It must be tailored to fit your specific environment.
  
  Investigate flagged results thoroughly to understand the root cause.
  
  Adjust exclusions, watchlists, or timeframes as needed to reduce false positives.
